name: build-and-push-docker-image
on: 
  push:
    branches:
      - master
      - dev
  pull_request:
    branches:
      - master
      - dev

jobs:
  base-os:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tags: ["amd64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        # if the event is push, set DIFF_POINT to the branch name
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
        # if the event is PR, set the DIFF_POINT to the target branch name
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
        # check if the branch is modified compared to the DIFF_POINT
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # check if the changes affect building the current image
      - name: set var
        run: echo "MISMATCH=$(grep "base-os" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - run: echo ${{ env.MISMATCH }}
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
        # build only when the change requires a new build and the event is not push to the master branch
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/${{ github.job }}
          file: ./commons/${{ github.job }}/Dockerfile.${{ matrix.tags }}
          tags: "cloudsuitetest/debian:${{ matrix.tags }}"
          platforms: linux/${{ matrix.tags }}
        # if the changes require a new build and the event is push to the master branch, login, build, and push
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/${{ github.job }}
          file: ./commons/${{ github.job }}/Dockerfile.${{ matrix.tags }}
          tags: "cloudsuitetest/debian:${{ matrix.tags }}"
          platforms: linux/${{ matrix.tags }}
          push: true
      
  # this job is a synchronization point to create a manifest list based on created images
  sync-base-os:
    runs-on: ubuntu-latest
    needs: base-os
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV  
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        run: |
          cd ./commons/base-os \
          && ./push.sh
  
  adoptopenjdk8:
    runs-on: ubuntu-latest
    needs: sync-base-os
    strategy:
      matrix:
        tags: ["adoptopenjdk8"] 
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/java/${{ github.job }}
          tags: "cloudsuitetest/java:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/java/${{ github.job }}
          tags: "cloudsuitetest/java:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true

  openjdk11:
    runs-on: ubuntu-latest
    needs: sync-base-os
    strategy:
      matrix:
        tags: ["amd64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/java/${{ github.job }}
          file: ./commons/java/${{ github.job }}/Dockerfile.${{ matrix.tags }}
          tags: "cloudsuitetest/java:${{ github.job }}_${{ matrix.tags }}"
          platforms: linux/${{ matrix.tags }}
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/java/${{ github.job }}
          file: ./commons/java/${{ github.job }}/Dockerfile.${{ matrix.tags }}
          tags: "cloudsuitetest/java:${{ github.job }}_${{ matrix.tags }}"
          platforms: linux/${{ matrix.tags }}
          push: true

  java: 
    runs-on: ubuntu-latest
    needs: [openjdk11]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|java" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV  
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        run: |
          cd ./commons/java/openjdk11 \
          && ./push.sh

  mysql:
    runs-on: ubuntu-latest
    needs: sync-base-os
    strategy:
      matrix:
        tags: ["mariadb-10.3"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/${{ github.job }}/
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/${{ github.job }}/
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true
    
  memcached:
    runs-on: ubuntu-latest
    needs: sync-base-os
    strategy:
      matrix:
        tags: ["1.6.6"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true
    
  hhvm:
    runs-on: ubuntu-latest
    needs: sync-base-os
    strategy:
      matrix:
        tags: ["3.30"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true
  
  faban:
    runs-on: ubuntu-latest
    needs: java
    strategy:
      matrix:
        tags: ["1.4"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|java\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true
    
  spark:
    runs-on: ubuntu-latest
    needs: java
    strategy:
      matrix:
        tags: ["2.4.5"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|java\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true

  siege:
    runs-on: ubuntu-latest
    needs: java
    strategy:
      matrix:
        tags: ["4.0.3rc3"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|java\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true

  cassandra:
    runs-on: ubuntu-latest
    needs: java
    strategy:
      matrix:
        tags: ["3.11.6"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|java\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true

  data-serving:
    runs-on: ubuntu-latest
    needs: cassandra
    strategy:
      matrix:
        tags: ["client", "server"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|java\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true
          
  hadoop:
    runs-on: ubuntu-latest
    needs: java
    strategy:
      matrix:
        tags: ["2.10.1"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|java\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true

  graphite-statsd:
    runs-on: ubuntu-latest
    needs: sync-base-os
    strategy:
      matrix:
        tags: ["0.9.15"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/graphite-statsd
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./commons/graphite-statsd
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true

  data-analytics:
    runs-on: ubuntu-latest
    needs: hadoop
    strategy:
      matrix:
        tags: ["4.0"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|java\|hadoop\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true

  data-caching:
    runs-on: ubuntu-latest
    needs: memcached
    strategy:
      matrix:
        tags: ["client", "server"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|java\|cassandra\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true

  django-workload:
    runs-on: ubuntu-latest
    needs: [cassandra, graphite-statsd, memcached, siege]
    strategy:
      matrix:
        tags: ["cassandra", "graphite", "memcached", "siege", "uwsgi"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|java\|cassandra\|graphite\|siege\|memcached\|uwsgi\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true

  fb-oss-performance:
    runs-on: ubuntu-latest
    needs: [mysql, siege, hhvm]
    strategy:
      matrix:
        tags: ["2019.02.13"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|java\|hhvm\|siege\|mysql\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true
  
  graph-analytics:
    runs-on: ubuntu-latest
    needs: spark
    strategy:
      matrix:
        tags: ["4.0"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|java\|spark\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64 
          push: true

  in-memory-analytics:
    runs-on: ubuntu-latest
    needs: spark
    strategy:
      matrix:
        tags: ["4.0"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|java\|spark\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true

  media-streaming:
    runs-on: ubuntu-latest
    needs: sync-base-os
    strategy:
      matrix:
        tags: ["client", "server", "dataset"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true
  
  web-search:
    runs-on: ubuntu-latest
    needs: [faban, java]
    strategy:
      matrix:
        tags: ["client", "server", "dataset"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|java\|faban\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - run: echo ${{env.MISMATCH}}
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true
  
  web-serving:
    runs-on: ubuntu-latest
    needs: [faban, mysql, memcached]
    strategy:
      matrix:
        tags: ["db_server", "faban_client", "memcached_server", "web_server"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|mysql\|java\|faban\|memcached\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./benchmarks/${{ github.job }}/${{ matrix.tags }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true
  
  movielens-dataset:
    runs-on: ubuntu-latest
    needs: sync-base-os
    strategy:
      matrix:
        tags: ["2019.12.03"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./datasets/${{ github.job }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags}}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build and push
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./datasets/${{ github.job }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags}}"
          platforms: linux/amd64
          push: true
  
  twitter-dataset-graph:
    runs-on: ubuntu-latest
    needs: sync-base-os
    strategy:
      matrix:
        tags: ["v1"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev' }}
        run: echo "DIFF_POINT=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
      - if: ${{ github.base_ref != ''}}
        run: echo "DIFF_POINT=${GITHUB_BASE_REF}" >> $GITHUB_ENV
      - name: Diffset
        id: diffset
        uses: softprops/diffset@v1
        with:
          base: ${{env.DIFF_POINT}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: set var
        run: echo "MISMATCH=$(grep "base-os\|${{github.job}}" <<< "${{steps.diffset.outputs.files}}")" >> $GITHUB_ENV
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build
        if: ${{ env.MISMATCH && github.ref != 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./datasets/${{ github.job }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
      - name: Login to Docker Hub
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: build
        if: ${{ env.MISMATCH && github.ref == 'refs/heads/master'}}
        uses: docker/build-push-action@v2
        with:
          context: ./datasets/${{ github.job }}
          tags: "cloudsuitetest/${{ github.job }}:${{ matrix.tags }}"
          platforms: linux/amd64
          push: true

